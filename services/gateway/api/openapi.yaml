openapi: 3.1.3
info:
  title: Perfume Recommendation Gateway API
  description: API для получения рекомендаций по парфюмерии
  version: 1.0.0
servers:
  - url: http://localhost:8080
    description: Локальный сервер разработки (порт 8080 согласно docker-compose)
  - url: http://gateway:8000
    description: Сервер в Docker

paths:
  /perfume/suggest:
    get:
      summary: Получить рекомендации по парфюмерии
      description: Возвращает список рекомендованных парфюмов на основе переданных параметров
      operationId: suggestPerfume
      tags:
        - Perfume
      parameters:
        - name: brand
          in: query
          description: Бренд парфюма
          required: true
          schema:
            type: string
            example: "Chanel"
        - name: name
          in: query
          description: Название парфюма
          required: true
          schema:
            type: string
            example: "No. 5"
        - name: sex
          in: query
          description: Пол (male/female/unisex)
          required: false
          default: "unisex"
          schema:
            type: string
            enum: [male, female, unisex]
            example: "female"
        - name: use_ai
          in: query
          description: Использовать AI для рекомендаций
          required: false
          schema:
            type: boolean
            default: false
            example: false
      responses:
        "200":
          description: Успешный ответ с рекомендациями
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Suggestions"
              example:
                suggested:
                  - perfume:
                      brand: "Chanel"
                      name: "No. 5"
                      sex: "female"
                      image_url: "https://example.com/image.jpg"
                      properties:
                        perfume_type: "Eau de Parfum"
                        family: ["Floral", "Aldehydic"]
                        upper_notes: ["Aldehydes", "Ylang-Ylang"]
                        core_notes: ["Jasmine", "Rose"]
                        base_notes: ["Vanilla", "Amber"]
                      shops:
                        - shop_name: "Shop1"
                          domain: "shop1.com"
                          variants:
                            - volume: 50
                              link: "https://shop1.com/product"
                              price: 5000
                    rank: 1
                    similarity_score: 0.95
        "204":
          description: Не удалось дать рекомендации (пустой список или нет данных)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "No recommendations available"
        "404":
          description: Духи не найдены
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "BAD_REQUEST"
                message: "perfume not found"
        "400":
          description: Неверные параметры запроса (отсутствует brand или name)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "BAD_REQUEST"
                message: "Wrong request parameters"
        "403":
          description: CORS не разрешен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "CORS not allowed"
                message: "CORS not allowed"
        "500":
          description: Ошибка взаимодействия с другими сервисами
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "INTERNAL_ERROR"
                message: "failed to interact with perfume service"

  /perfume/suggest-by-tags:
    get:
      summary: Получить рекомендации по парфюмерии на основе тегов
      description: Возвращает список рекомендованных парфюмов на основе переданных тегов. Теги передаются через запятую.
      operationId: suggestPerfumeByTags
      tags:
        - Perfume
      parameters:
        - name: tags
          in: query
          description: |
            Теги для поиска (через запятую). 
            Доступные теги: light, airy, soft, rich, dense, sharp, bright, muted, warm, cold, fresh, cool, cozy, sweet, bitter, sour, salty, spicy, vanillic, caramel, gourmand, powdery, velvety, dry, wet, smoky, soapy, leathery, woody, floral, fruity, green, marine, herbal, resinous, earthy, mossy, romantic, sensual, calm, invigorating, mysterious, elegant, energetic, bold, clean, noble
          required: true
          schema:
            type: string
            example: "floral,sweet,romantic"
        - name: sex
          in: query
          description: Пол (male/female/unisex). По умолчанию unisex
          required: false
          default: "unisex"
          schema:
            type: string
            enum: [male, female, unisex]
            example: "female"
      responses:
        "200":
          description: Успешный ответ с рекомендациями
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Suggestions"
              example:
                suggested:
                  - perfume:
                      brand: "Chanel"
                      name: "Coco Mademoiselle"
                      sex: "female"
                      image_url: "https://example.com/image.jpg"
                      properties:
                        perfume_type: "Eau de Parfum"
                        family: ["Floral", "Oriental"]
                        upper_notes: ["Orange", "Mandarin Orange"]
                        core_notes: ["Rose", "Jasmine"]
                        base_notes: ["Patchouli", "Vanilla"]
                        tags:
                          fresh: 1
                          spicy: 2
                          woody: 3
                      shops:
                        - shop_name: "Gold Apple"
                          domain: "https://goldapple.ru"
                          variants:
                            - volume: 50
                              link: "https://goldapple.ru/product"
                              price: 8500
                    rank: 1
                    similarity_score: 0.92
        "204":
          description: Не удалось дать рекомендации (пустой список или нет данных)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "No recommendations available"
        "400":
          description: Неверные параметры запроса (отсутствует параметр tags)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "BAD_REQUEST"
                message: "Wrong request parameters"
        "403":
          description: CORS не разрешен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "CORS_NOT_ALLOWED"
                message: "CORS not allowed"
        "500":
          description: Ошибка взаимодействия с другими сервисами
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                error: "INTERNAL_ERROR"
                message: "Internal server error"

components:
  schemas:
    Suggestions:
      type: object
      required:
        - suggested
      properties:
        suggested:
          type: array
          items:
            $ref: "#/components/schemas/Ranked"

    Ranked:
      type: object
      required:
        - perfume
      properties:
        perfume:
          $ref: "#/components/schemas/Perfume"
        rank:
          type: integer
          description: Ранг рекомендации
          example: 1
        similarity_score:
          type: number
          format: float
          description: Оценка схожести
          example: 0.95

    Perfume:
      type: object
      required:
        - brand
        - name
        - sex
        - properties
      properties:
        brand:
          type: string
          description: Бренд духов
          example: "Chanel"
        name:
          type: string
          description: Название духов
          example: "No. 5"
        sex:
          type: string
          enum: [male, female, unisex]
          description: Пол
          example: "female"
        image_url:
          type: string
          format: uri
          description: URL изображения
          example: "https://example.com/image.jpg"
        properties:
          $ref: "#/components/schemas/Properties"
        shops:
          type: array
          items:
            $ref: "#/components/schemas/ShopInfo"

    Properties:
      type: object
      required:
        - perfume_type
        - family
        - upper_notes
        - core_notes
        - base_notes
      properties:
        perfume_type:
          type: string
          example: "Eau de Parfum"
        family:
          type: array
          items:
            type: string
          example: ["Floral", "Aldehydic"]
        upper_notes:
          type: array
          items:
            type: string
          example: ["Aldehydes", "Ylang-Ylang"]
        core_notes:
          type: array
          items:
            type: string
          example: ["Jasmine", "Rose"]
        base_notes:
          type: array
          items:
            type: string
          example: ["Vanilla", "Amber"]
        tags:
          type: object
          additionalProperties:
            type: integer
          description: Теги парфюма (опциональное поле, может отсутствовать)
          example:
            fresh: 1
            spicy: 2
            woody: 3
        enriched_upper_notes:
          type: array
          description: Обогащенные верхние ноты с тегами и характеристиками (опциональное поле)
        enriched_core_notes:
          type: array
          description: Обогащенные средние ноты с тегами и характеристиками (опциональное поле)
        enriched_base_notes:
          type: array
          description: Обогащенные базовые ноты с тегами и характеристиками (опциональное поле)
        upper_characteristics:
          type: object
          additionalProperties:
            type: number
            format: float
          description: Характеристики верхних нот (опционально)
          example:
            fresh: 0.8
            citrus: 0.6
        core_characteristics:
          type: object
          additionalProperties:
            type: number
            format: float
          description: Характеристики средних нот (опционально)
          example:
            floral: 0.9
            sweet: 0.7
        base_characteristics:
          type: object
          additionalProperties:
            type: number
            format: float
          description: Характеристики базовых нот (опционально)
          example:
            woody: 0.8
            warm: 0.6

    ShopInfo:
      type: object
      required:
        - shop_name
        - domain
        - variants
      properties:
        shop_name:
          type: string
          description: Название магазина
          example: "Gold Apple"
        domain:
          type: string
          description: Домен магазина
          example: "goldapple.ru"
        image_url:
          type: string
          format: uri
          description: URL изображения из магазина
          example: "https://example.com/shop-image.jpg"
        variants:
          type: array
          items:
            $ref: "#/components/schemas/Variant"

    Variant:
      type: object
      required:
        - volume
        - price
        - link
      properties:
        volume:
          type: integer
          description: Объем в миллилитрах
          example: 50
        price:
          type: integer
          description: Цена в рублях
          example: 5000
        link:
          type: string
          format: uri
          description: Ссылка на товар в магазине
          example: "https://goldapple.ru/perfume/123"

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Тип ошибки
        message:
          type: string
          description: Сообщение об ошибке
